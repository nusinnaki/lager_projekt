<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Konstanz Lager</title>
  <style>
    body { font-family: Arial; max-width: 1100px; margin: 30px auto; }
    .top { display: flex; align-items: center; justify-content: space-between; gap: 16px; }
    .top a { text-decoration: none; color: #111; border: 1px solid #111; border-radius: 10px; padding: 8px 12px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; margin-top: 18px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f6f6f6; text-align: left; }
    input, select { width: 100%; padding: 8px; }
    button { padding: 8px 12px; }
    .muted { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <div class="top">
    <h1>Konstanz Lager</h1>
    <a href="index.html">Back</a>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Take products</h2>
      <label>Worker</label><br>
      <select id="take_worker"></select><br><br>

      <label>Product</label><br>
      <select id="take_product"></select><br><br>

      <label>Quantity</label><br>
      <input id="take_qty" type="number" min="1" value="1"><br><br>

      <button onclick="submitMove('take')">Take</button>

      <hr>

      <h2>Load products</h2>
      <label>Worker</label><br>
      <select id="load_worker"></select><br><br>

      <label>Product</label><br>
      <select id="load_product"></select><br><br>

      <label>Quantity</label><br>
      <input id="load_qty" type="number" min="1" value="1"><br><br>

      <button onclick="submitMove('load')">Load</button>

      <p class="muted" id="status"></p>
    </div>

    <div class="card">
      <h2>Current stock</h2>
      <input id="search" placeholder="Search product name..." onkeyup="filterTable()"><br><br>
      <table id="stockTable">
        <thead><tr><th>Product</th><th>Qty</th></tr></thead>
        <tbody id="stockBody"></tbody>
      </table>
      <p class="muted">Showing up to 500 items.</p>
    </div>
  </div>

<script>
  const SITE = "konstanz";
  const API = `http://127.0.0.1:8000/api/${SITE}`;

  function opt(value, label) {
    const o = document.createElement("option");
    o.value = value;
    o.textContent = label;
    return o;
  }

  async function loadLists() {
    const [workers, products] = await Promise.all([
      fetch(`${API}/workers`).then(r => r.json()),
      fetch(`${API}/products`).then(r => r.json())
    ]);

    const w1 = document.getElementById("take_worker");
    const w2 = document.getElementById("load_worker");
    w1.innerHTML = ""; w2.innerHTML = "";
    workers.forEach(w => { w1.appendChild(opt(w.id, w.name)); w2.appendChild(opt(w.id, w.name)); });

    const p1 = document.getElementById("take_product");
    const p2 = document.getElementById("load_product");
    p1.innerHTML = ""; p2.innerHTML = "";
    products.forEach(p => { p1.appendChild(opt(p.id, p.name)); p2.appendChild(opt(p.id, p.name)); });
  }

  async function loadStock() {
    const stock = await fetch(`${API}/stock?limit=500`).then(r => r.json());
    const body = document.getElementById("stockBody");
    body.innerHTML = "";
    stock.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${row.name}</td><td style="text-align:right">${row.quantity}</td>`;
      body.appendChild(tr);
    });
  }

  function filterTable() {
    const input = document.getElementById("search").value.toLowerCase();
    const rows = document.querySelectorAll("#stockTable tbody tr");
    rows.forEach(r => {
      const name = r.children[0].innerText.toLowerCase();
      r.style.display = name.includes(input) ? "" : "none";
    });
  }

  async function submitMove(kind) {
    const status = document.getElementById("status");
    status.textContent = "";

    const worker_id = Number(document.getElementById(`${kind}_worker`).value);
    const product_id = Number(document.getElementById(`${kind}_product`).value);
    const qty = Number(document.getElementById(`${kind}_qty`).value);

    const endpoint = kind === "take" ? "take" : "load";

    const res = await fetch(`${API}/${endpoint}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ worker_id, product_id, qty })
    });

    if (!res.ok) {
      const msg = await res.json().catch(() => ({detail: "error"}));
      status.textContent = `Error: ${msg.detail || "error"}`;
      return;
    }

    status.textContent = "Saved.";
    await loadStock();
  }

  (async () => {
    await loadLists();
    await loadStock();
  })();
</script>
</body>
</html>
